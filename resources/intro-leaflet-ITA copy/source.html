<h1>Step 1 - Prepariamo la pagina</h1>

<p>Apriamo il file <code>index.html</code> .
Per prima cosa andiamo a caricare la libreria Leaflet (file con estensione .js), insieme con il relativo foglio di stile (estensione .css).<br>
Per fare questo aggiungiamo i link agli scripts necessari in fondo al file, ma prima della chiusura del <code>body</code> (cioè prima del tag <code>&lt;/body&gt;</code>) :</p>

<pre><code>    &lt;script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"&gt;&lt;/script&gt;
    &lt;link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" /&gt;
</code></pre>

<p>Poi aggiungiamo il codice per definire lo stile della pagina e della mappa (dimensioni, posizione ecc..). Per fare questo usiamo un tag particolare <code>&lt;style&gt;&lt;/style&gt;</code>dentro cui mettere il codice. Questo tag ed il suo contenuto vanno messi all'interno dell'<code>&lt;header&gt;&lt;/header&gt;</code></p>

<pre><code>    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
</code></pre>

<p>Solitamente è buona pratica separare il codice relativo al contenuto (HTML) dallo stile (CSS), mettendo il secondo in un file a sè stante, ma per comodità questa volta terremo tutto insieme all'interno del tag <code>&lt;header&gt;&lt;/header&gt;</code>.</p>

<p>Se vi siete persi, nessuna paura!  </p>

<p>Qui di seguito (ed in fondo ad ogni successivo paragrafo), potete trovare un file con il codice relativo scritto fino a questo punto.<br>
<a href="https://gist.github.com/miccferr/911a05127bbacb658d0c"> <strong>File step1</strong> </a></p>

<h1>Step 2 - La nostra prima web-map</h1>

<p>Per prima cosa andiamo a definire il <code>div</code>, ovvero l'elemento HTML usato per delimitare parte di una pagina web (<a href="http://en.wikipedia.org/wiki/Span_and_div">più info qui</a>),  che conterrà la nostra mappa.<br>
Posizioniamolo all'interno del <code>&lt;body&gt;&lt;/body&gt;</code>.<br>
Cosi:</p>

<pre><code>&lt;div id='map'&gt;&lt;/div&gt;
</code></pre>

<p>Ora, con due righe di javascript chiediamo a Leaflet di creare una mappa dentro a questo div. Per fare questo useremo un tag simile a quello usato in precedenza per definire lo stile, ma pensato per contenre del codice javascript invece che del CSS. Inserite questa parte in fondo al file, dopo lo il link a Leaflet, e sempre prima della chiusura del tag <code>body</code>.</p>

<pre><code>&lt;script &gt;

    //creo una mappa con relativa posizione e zoom iniziali
     var map = L.map('map').setView([45.4588, 9.2010], 15);

    //aggiungo un layer di sfondo, o Base Layer
    var baseLayer = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
            attribution: 'Map data &amp;copy; &lt;a href="http://openstreetmap.org"&gt;OpenStreetMap&lt;/a&gt; contributors, &lt;a href="http://creativecommons.org/licenses/by-sa/2.0/"&gt;CC-BY-SA&lt;/a&gt;, Imagery © &lt;a href="http:// mapbox.com"&gt;Mapbox&lt;/a&gt;',
            maxZoom: 18
        }).addTo(map);

&lt;/script&gt;
</code></pre>

<p>Se tutto è andato bene, questo è quello che dovreste vedere:
<a href="/maptime/milan/blob/gh-pages/resources/edizione1/tutorial/img-tutorial/img-tutorial2.png" target="_blank"><img src="/maptime/milan/raw/gh-pages/resources/edizione1/tutorial/img-tutorial/img-tutorial2.png" alt="imm2" style="max-width:100%;"></a></p>

<p>Non è molto, ma è pur sempre un inzio..congratulatevi con voi stessi per aver creato la vostra prima mappetta web.</p>

<p><a href="https://gist.github.com/miccferr/57baf93464af13769906"><strong>File step2</strong></a> </p>

<h1>Step 3 <br> Creare un marker</h1>

<p>E' ora di mettere qualche puntina su questa cartina.
Per aggiungere un marker, Leaflet offre un metodo molto intuitivo tramite il costruttore <code>L.marker([lat, lng])</code>.<br>
Questi necessita obbligatoriamente di un array di coordinate <code>[Latitudine, Longitudine]</code>, oltre a disporre di alcuni metodi opzionali, come <code>.bindPopup()</code> per visualizzare un baloon sopra il marker.
Aggiungiamo quindi il seguente codice, di seguito a quello scritto in precedenza:</p>

<pre><code>// Oggetto marker
var openDotMarker = L.marker([45.448198, 9.222020])
    .bindPopup('&lt;b&gt;Opendot&lt;/b&gt; &lt;br&gt; Weeeee!')
    .openPopup()
    .addTo(map);
</code></pre>

<p>Risultato:
<a href="/maptime/milan/blob/gh-pages/resources/edizione1/tutorial/img-tutorial/img-tutorial3.png" target="_blank"><img src="/maptime/milan/raw/gh-pages/resources/edizione1/tutorial/img-tutorial/img-tutorial3.png" alt="imm3" style="max-width:100%;"></a></p>

<p><a href="https://gist.github.com/miccferr/d1b811ee62aedcff2780"><strong>File step3</strong></a> </p>

<h1>Step 4 <br> Modificare un icona</h1>

<p>Per personalizzare il marker è possibile modificare l'icona di default con una creata a piacere.<br>
Creiamo una variabile 'icona' a cui associamo un oggetto, con il metodo <code>L.icon()</code>.
Notate che due proprietà di quest'oggetto, ovvero i campi <code>iconUrl</code> e <code>shadowUrl</code> sono proprio gli URL delle icone che voglio linkare, relativi rispettivamente al file dell'immagine stessa ed ad file con l'immagine della sua ombra, per creare una sorta di effetto prospettico.
Le altre proprietà gestiscono invece le dimensioni delle icone.
<a href="http://leafletjs.com/examples/custom-icons.html">Qui</a> maggiori informazioni.</p>

<pre><code>    // Icona Marker
    var openDotIcon = L.icon({
        iconUrl: 'img/opendot-marker.png',
        shadowUrl: 'img/opendot-marker-shadow.png',
        iconSize:     [80, 80], // size of the icon
        shadowSize:   [80, 80], // size of the shadow
        iconAnchor:   [0, 0], // point of the icon which will correspond to marker's location
        shadowAnchor: [0, 0],  // the same for the shadow
        popupAnchor:  [60, 15] // point from which the popup should open relative to the iconAnchor
    });
</code></pre>

<p>Una volta costruito l'oggetto 'icona', possiamo ricreare il marker, ma questa volta passandogli come parametro opzionale proprio la nostra icona customizzata. </p>

<pre><code>    var openDotMarker = L.marker([45.448198, 9.222020],
        { icon: openDotIcon}) // NOTA: questa opzione non era presente nello step3
        .bindPopup('&lt;b&gt;Opendot&lt;/b&gt; &lt;br&gt; Weeeee!')
        .openPopup()
        .addTo(map);
</code></pre>

<p>Risultato:
<a href="/maptime/milan/blob/gh-pages/resources/edizione1/tutorial/img-tutorial/img-tutorial4.png" target="_blank"><img src="/maptime/milan/raw/gh-pages/resources/edizione1/tutorial/img-tutorial/img-tutorial4.png" alt="imm4" style="max-width:100%;"></a></p>

<p><a href="https://gist.github.com/miccferr/841a6c50a71ba0c4dd46"><strong>File step4</strong></a></p>

<h1>
<a id="user-content-step-5---geojson-ftw" class="anchor" href="#step-5---geojson-ftw" aria-hidden="true"><span class="octicon octicon-link"></span></a>Step 5 - GeoJSON FTW!</h1>

<p>Di soli marker non si vive.
Un' altra strada per mettere quindi dei dati su una mappa web, è quella di utilizzare il formato <a href="http://geojson.org/">GeoJSON</a>, diventato oramai di diritto uno degli standard più diffusi di scambio dati geospaziali (insieme al 'classico' formato proprietario ESRI shapefile).<br>
Di seguito un esempio di GeoJSON (da <a href="http://geojson.org/">geojson.org</a> ):</p>

<pre><code>{
  "type": "Feature",
  "geometry": {
    "type": "Point",
    "coordinates": [125.6, 10.1]
  },
  "properties": {
    "name": "Dinagat Islands"
  }
}
</code></pre>

<p>Esistono vari modi per caricare un file GeoJSON (es: AJAX, JQuery $.getJSON()..).  Noi useremo un metodo proprio di Leaflet.  </p>

<p>Per prima cosa richiamiamo il file contenente i dati, con un link posto dopo quello per richiamare Leaflet:</p>

<pre><code>&lt;script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"&gt;&lt;/script&gt;
&lt;link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" /&gt;
&lt;!-- Dati --&gt;
&lt;script src="data/fontanelle.js"&gt; &lt;/script&gt;
</code></pre>

<p>Fermiamoci un momento ed apriamo il file <code>data/fontanelle.js</code>. Potete notare come il GeoJSON sia stato racchiuso nella variabile <code>fontanelle</code>.<br>
In questo modo possiamo infatti passare comodamente tutti i dati in una volta sola, come unico parametro, alla funzione <code>L.geojson()</code>. Sarà lei infatti a costruire per noi il Feature Layer contenente i dati:</p>

<pre><code>// Dati GeoJSON
var fontane = L.geoJson(fontanelle, {
    pointToLayer : function  (feature, latlng) {
        lat = feature.geometry.coordinates[0];
        lng = feature.geometry.coordinates[1];
        return L.marker([lng,lat]).bindPopup("Andiamo a bere al Bar del Drago Verde!");
    }
}).addTo(map);
</code></pre>

<p>Un punto su cui fare attenzione è come nella funzione <code>L.geojson()</code> le singole <code>features</code>di cui si compone l'insieme di dati vengano passate a <code>pointToLayer()</code>. Questo perchè, a differenza di altre geometrie come linee e poligoni, Leaflet per i punti disegna sempre, di default, dei marker. Fate ad esempio un confronto con il codice in <a href="http://luxembourgjs.github.io/leaflet-demo/#/15">questa slide</a>. Per maggiori informazioni su questo aspetto fare riferimento a <a href="http://leafletjs.com/examples/geojson.html">questa pagina</a>. </p>

<p>(<strong>Nota tecnica</strong>: Esistono inoltre varie tipologie di geometrie rappresentabili con la struttura dati GeoJSON: '<em>A geometry is a GeoJSON object where the type member's value is one of the following strings: "Point", "MultiPoint", "LineString", "MultiLineString", "Polygon", "MultiPolygon", or "GeometryCollection".</em>' <a href="http://geojson.org/geojson-spec.html#geometry-objects">fonte:geojson.org</a> ).</p>

<p>Risultato:
<a href="/maptime/milan/blob/gh-pages/resources/edizione1/tutorial/img-tutorial/img-tutorial5.png" target="_blank"><img src="/maptime/milan/raw/gh-pages/resources/edizione1/tutorial/img-tutorial/img-tutorial5.png" alt="imm5" style="max-width:100%;"></a></p>

<p><a href="https://gist.github.com/miccferr/1a8763b20fa0bb9b9508"><strong>File step5</strong></a> </p>

<h1>
<a id="user-content-step-6---geojson-ftw-pt2" class="anchor" href="#step-6---geojson-ftw-pt2" aria-hidden="true"><span class="octicon octicon-link"></span></a>Step 6 - GeoJSON FTW! pt.2</h1>

<p>Analogamente a quanto fatto per un singolo marker, se volessimo quindi modficare l'aspetto dei dati, dovremo quindi creare una variabile contenete lo stile dell'icona con cui vestire i dati..</p>

<pre><code>// Icona GeoJSON
var fontanella = L.icon ({
    iconUrl: 'img/vedovella.png',
    shadowUrl: 'img/vedovella-shadow.png',
    iconSize:     [80, 93], // size of the icon
    shadowSize:   [80, 93], // size of the shadow
    iconAnchor:   [0, 0 ], // point of the icon which will correspond to marker's location
    shadowAnchor: [0, 0],  // the same for the shadow
    popupAnchor:  [45, 10] // point from which the popup should open relative to the iconAnchor
});
</code></pre>

<p>..e  passarla come parametro alla funzione <code>L.marker()</code></p>

<pre><code>// Dati GeoJSON
var fontane = L.geoJson(fontanelle, {
    pointToLayer : function  (feature, latlng) {
        lat = feature.geometry.coordinates[0];
        lng = feature.geometry.coordinates[1];
        return L.marker([lng,lat],
         {icon: fontanella}) // NOTA: questa opzione non era presente prima
         .bindPopup("Andiamo a bere al Bar del Drago Verde!");
    }
}).addTo(map);
</code></pre>

<p>Risultato:
<a href="/maptime/milan/blob/gh-pages/resources/edizione1/tutorial/img-tutorial/img-tutorial6.png" target="_blank"><img src="/maptime/milan/raw/gh-pages/resources/edizione1/tutorial/img-tutorial/img-tutorial6.png" alt="imm6" style="max-width:100%;"></a></p>

<p><a href="https://gist.github.com/miccferr/62a335f69ed98474345f"><strong>File step6</strong></a> </p>

<h1>
<a id="user-content-step-7---layers-control" class="anchor" href="#step-7---layers-control" aria-hidden="true"><span class="octicon octicon-link"></span></a>Step 7 - Layers Control</h1>

<p>Dopo aver messo i dati su mappa pensiamo infine ad offire la possibilità all'utente di poterli gestire accendendoli e spegnendoli a piacimento. E magari potendo cambiare anche il layer di sfondo (Base Layer).<br>
Per farlo dobbiamo usare un piccolo menù che controlli la visibilità di Base Layers e Feature Layers.</p>

<p>Partiamo quindi inizializzando delle nuove variabili a cui associare due nuovi layer di sfondo:</p>

<pre><code>// Mapbox Streets
//---------------
var mapboxTilesStreet = L.tileLayer('https://{s}.tiles.mapbox.com/v3/examples.map-i86nkdio/{z}/{x}/{y}.png', {
         attribution: '&lt;a href="http://www.mapbox.com/about/maps/" target="_blank"&gt;Terms &amp;amp; Feedback&lt;/a&gt;'
     })

// Mapbox Medieval
//---------------
var mapboxTilesMedieval = L.tileLayer('https://{s}.tiles.mapbox.com/v3/spatial.b625e395/{z}/{x}/{y}.png', {
         attribution: '&lt;a href="http://www.mapbox.com/about/maps/" target="_blank"&gt;Terms &amp;amp; Feedback&lt;/a&gt;'
     });
</code></pre>

<p>Notate come per questi due layer non sia stato usato il metodo <code>.addTo(map)</code> per aggiungerli al div della mappa. Questo perchè vogliamo tenerli spenti di default, e poterli accendere solo in un secondo momento (uno alla volta ), tramite il menù di controllo.</p>

<p>Ora costruiamo due oggetti in cui salvare i riferimenti rispettivamente ai BaseLayers ed ai FeatureLayers, e che passeremo alla funzione <code>L.control.layers()</code> responsabile della creazione del menù.</p>

<pre><code>    // Creo due oggetti con i riferimenti rispettivamente ai BaseLayers ed ai FeatureLayers
    var baseMaps={
        "Sfondo OSM": baseLayer,
        "Sfondo Mapbox Streets": mapboxTilesStreet,
        "Sfondo Mapbox Medieval": mapboxTilesMedieval
    };
    var featureLayers={
        "Vedovelle": fontane,
        "Logo Opendot" : openDotMarker
    };
    // Creo i controlli
    L.control.layers(baseMaps, featureLayers).addTo(map);
    // Per un metodo moolto più succinto (che usa però Mapbox.js) guardare questo link: https://www.mapbox.com/mapbox.js/example/v1.0.0/toggle-baslayers/
</code></pre>

<p>Se anche questo passaggio è andato a buon fine, dovreste trovare un menù in alto a dx con cui poter   controllare i vostri layers.</p>

<p>Risultato:
<a href="/maptime/milan/blob/gh-pages/resources/edizione1/tutorial/img-tutorial/img-tutorial7.png" target="_blank"><img src="/maptime/milan/raw/gh-pages/resources/edizione1/tutorial/img-tutorial/img-tutorial7.png" alt="imm7" style="max-width:100%;"></a></p>

<p><a href="https://gist.github.com/miccferr/c51f3035ea31aee23184"><strong>File step7</strong></a> </p>

<h1>
<a id="user-content--opzionale--solo-per-i-mappatori-più-tenacisopravvissuti" class="anchor" href="#-opzionale--solo-per-i-mappatori-pi%C3%B9-tenacisopravvissuti" aria-hidden="true"><span class="octicon octicon-link"></span></a>[ OPZIONALE ]: Solo per i mappatori più tenaci(sopravvissuti)</h1>

<h1>
<a id="user-content-step-8---plugins-marker-clusterer" class="anchor" href="#step-8---plugins-marker-clusterer" aria-hidden="true"><span class="octicon octicon-link"></span></a>Step 8 - Plugins: Marker Clusterer</h1>

<p>Leaflet è un libreria semplicissima e snella, ma al tempo stesso in grado di offrire molte funzionalità, grazie all'enorme numero di plugins sviluppati dall comunità.  </p>

<p>A titolo d'esempio vediamo come installare ed utilizzare un plugin, Leaflet <a href="https://github.com/Leaflet/Leaflet.markercluster">MarkerClusterer</a>, per aggregare le fontanelle in cluster, al variare del livello di zoom.</p>

<p>Come prima cosa linkiamo la libreria <code>leaflet.markercluster</code> come qualsiasi altro script js (è un qualsiasi script javascript!):</p>

<pre><code>&lt;script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"&gt;&lt;/script&gt;
&lt;link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" /&gt;
&lt;!-- leaflet.markercluster --&gt;
&lt;link rel="stylesheet" href="js/leaflet.markercluster/MarkerCluster.css" /&gt;
&lt;link rel="stylesheet" href="js/leaflet.markercluster/MarkerCluster.Default.css" /&gt;
&lt;script src="js/leaflet.markercluster/leaflet.markercluster-src.js" &gt;&lt;/script&gt;
&lt;script src="js/leaflet.markercluster/leaflet.markercluster.js" &gt;&lt;/script&gt;
&lt;!-- Dati --&gt;
&lt;script src="data/fontanelle.js"&gt; &lt;/script&gt;
</code></pre>

<p>Dopodichè  seguiamo le istruzioni riporate sulla repo di <a href="https://github.com/Leaflet/Leaflet.markercluster">MarkerClusterer</a> e creiamo un nuovo oggetto <code>MarkerClusterGroup</code>, a cui passiamo le features del layer <code>fontane</code>. Da ultimo aggiungiamo lo stesso sulla mappa.</p>

<pre><code>var markers = new L.MarkerClusterGroup();
markers.addLayer(fontane);
//... Add more layers ...
map.addLayer(markers);
</code></pre>

<p>Attenzione! L'ultimo passaggio è ora togliere il metodo <code>addTo(map)</code> da <code>L.geojson(fontane)</code>, altrimenti finirei con il caricare due volte lo stesso layer (uno all'inzio uso il GeoJSON per creare il layer di fontanelle, ed uno ora tramite markerClusterer)</p>

<p>Voilà:
<a href="/maptime/milan/blob/gh-pages/resources/edizione1/tutorial/img-tutorial/img-tutorial8.png" target="_blank"><img src="/maptime/milan/raw/gh-pages/resources/edizione1/tutorial/img-tutorial/img-tutorial8.png" alt="imm8" style="max-width:100%;"></a></p>

<p><a href="https://gist.github.com/miccferr/bcf6f4308383ef52198e"><strong>File step8</strong></a> </p>

<h1>
<a id="user-content--fin-" class="anchor" href="#-fin-" aria-hidden="true"><span class="octicon octicon-link"></span></a>~ Fin ~</h1>
</article>
  </div>

</div>
